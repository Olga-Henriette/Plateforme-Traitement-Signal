// =========================================================================
// Traitement du theme liaison radio
// =========================================================================
function traitement_liaison_radio()
    global app_state;
    
    disp('Debut traitement liaison radio...');
    
    try
        parameters = app_state.params.theme5;
        
        sampling_frequency = 22050; // fe
        sampling_period = 1/sampling_frequency; // Te
        
        disp('Generation du message binaire...');
        
        // Binary message 
        transmitted_bits = round(rand(1, parameters.nb_bits));
        
        disp('Modulation OOK...');
        
        // OOK Modulation 
        modulation_time = 0:sampling_period:(parameters.nb_bits * parameters.duree_bit - sampling_period);
        modulated_signal = zeros(1, length(modulation_time));
        
        for i = 1:parameters.nb_bits
            bit_start = (i-1) * parameters.duree_bit;
            bit_end = i * parameters.duree_bit;
            bit_indices = find(modulation_time >= bit_start & modulation_time < bit_end);
            
            if transmitted_bits(i) == 1 then
                carrier_frequency = parameters.f_porteuse;
                modulated_signal(bit_indices) = sin(2*%pi*carrier_frequency*modulation_time(bit_indices));
            end
        end
        
        disp('Ajout du bruit de canal...');
        
        // Noisy channel (Canal bruite)
        signal_power = mean(modulated_signal.^2);
        
        // Calculate noise power based on SNR (Calcul de la puissance du bruit basee sur le SNR)
        if signal_power > 0 then
            noise_power = signal_power / (10^(parameters.snr_db/10));
        else
            noise_power = 0.01;
        end
        
        channel_noise = sqrt(noise_power) * rand(1, length(modulated_signal), 'normal');
        received_signal = modulated_signal + channel_noise;
        
        disp('Demodulation...');
        
        // Demodulation (Demodulation)
        demodulated_signal = received_signal .* sin(2*%pi*parameters.f_porteuse*modulation_time);
        
        // Low-pass filter (Filtre passe-bas)
        cutoff_frequency = 50;
        // Correction: Scilab utilise fe/2 (frequence de Nyquist) pour la normalisation dans iir
        lowpass_filter_coeffs = iir(6, 'lp', 'butt', cutoff_frequency/(sampling_frequency/2), 0.1); 
        filtered_signal = flts(demodulated_signal, lowpass_filter_coeffs);
        
        disp('Decision binaire...');
        
        // Decision (Decision binaire)
        received_bits = zeros(1, parameters.nb_bits);
        decision_threshold = 0.1;
        
        for i = 1:parameters.nb_bits
            bit_start = (i-1) * parameters.duree_bit;
            bit_end = i * parameters.duree_bit;
            bit_indices = find(modulation_time >= bit_start & modulation_time < bit_end);
            sample_index = round(mean(bit_indices));
            
            if filtered_signal(sample_index) > decision_threshold then
                received_bits(i) = 1;
            end
        end
        
        // BER calculation (Calcul du BER)
        errors = sum(transmitted_bits ~= received_bits);
        bit_error_rate = errors / parameters.nb_bits; // BER
        
        disp('Affichage des graphiques...');
        
        // Display (Affichage)
        afficher_graphiques_radio(transmitted_bits, received_bits, modulated_signal, filtered_signal, modulation_time, parameters, bit_error_rate);
        
        // Interpretation (Interpretation)
        if bit_error_rate == 0 then
            interpretation_text = sprintf('Transmission parfaite ! Les %d bits ont ete recus sans erreur (BER = 0%%). SNR: %.1f dB.', ...
                            parameters.nb_bits, parameters.snr_db);
        else
            interpretation_text = sprintf('%d erreur(s) sur %d bits (BER = %.1f%%). Augmentez le SNR (%.1f dB) pour ameliorer la fiabilite.', ...
                            errors, parameters.nb_bits, bit_error_rate*100, parameters.snr_db);
        end
        
        mettre_a_jour_interpretation(interpretation_text);
        
        disp('Traitement liaison radio termine !');
        
    catch
        disp('ERREUR dans traitement_liaison_radio');
        err = lasterror();
        disp('Message : ' + err.message);
        mettre_a_jour_interpretation('Erreur lors du traitement radio. Voir console.');
    end
endfunction
