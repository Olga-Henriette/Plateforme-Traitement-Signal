// =========================================================================
// PROCESS_RADIO.SCI - Traitement du theme liaison radio (Modulation OOK)
// =========================================================================
function process_radio_module() // Ancien traitement_liaison_radio
    global app_state;
    
    disp('Debut traitement liaison radio...');
    
    // RAPPEL : Les noms de variables sont en Anglais.
    
    try
        // Récupérer les paramètres du module 'radio'
        module_config = app_state.modules.radio;
        parameters = module_config.default_params;
        
        sampling_frequency = 22050; // fe
        sampling_period = 1/sampling_frequency; // Te
        
        disp('Generation du message binaire...');
        
        // Binary message (Message binaire)
        transmitted_bits = round(rand(1, parameters.number_of_bits));
        
        disp('Modulation OOK...');
        
        // OOK Modulation (Modulation OOK)
        modulation_duration = parameters.number_of_bits * parameters.bit_duration_s;
        modulation_time = 0:sampling_period:(modulation_duration - sampling_period);
        modulated_signal = zeros(1, length(modulation_time));
        carrier_frequency = parameters.carrier_freq_hz;
        
        for i = 1:parameters.number_of_bits
            bit_start_time = (i-1) * parameters.bit_duration_s;
            bit_end_time = i * parameters.bit_duration_s;
            bit_indices = find(modulation_time >= bit_start_time & modulation_time < bit_end_time);
            
            if transmitted_bits(i) == 1 then
                modulated_signal(bit_indices) = sin(2*%pi*carrier_frequency*modulation_time(bit_indices));
            end
        end
        
        disp('Ajout du bruit de canal...');
        
        // Noisy channel (Canal bruite)
        signal_power = mean(modulated_signal.^2);
        
        // Calculate noise power based on SNR (Calcul de la puissance du bruit basee sur le SNR)
        if signal_power > 0 then
            noise_power = signal_power / (10^(parameters.snr_db/10));
        else
            noise_power = 0.01;
        end
        
        channel_noise = sqrt(noise_power) * rand(1, length(modulated_signal), 'normal');
        received_signal = modulated_signal + channel_noise;
        
        disp('Demodulation...');
        
        // Demodulation (Demodulation coherente)
        demodulated_signal = received_signal .* sin(2*%pi*carrier_frequency*modulation_time);
        
        // Low-pass filter (Filtre passe-bas)
        cutoff_frequency = 50;
        // Normalisation par la fréquence de Nyquist (fe/2)
        lowpass_filter_coeffs = iir(6, 'lp', 'butt', cutoff_frequency/(sampling_frequency/2), 0.1); 
        filtered_signal = flts(demodulated_signal, lowpass_filter_coeffs);
        
        disp('Decision binaire...');
        
        // Decision (Decision binaire)
        received_bits = zeros(1, parameters.number_of_bits);
        decision_threshold = 0.1;
        
        for i = 1:parameters.number_of_bits
            bit_start_time = (i-1) * parameters.bit_duration_s;
            bit_end_time = i * parameters.bit_duration_s;
            bit_indices = find(modulation_time >= bit_start_time & modulation_time < bit_end_time);
            sample_index = round(mean(bit_indices)); // Échantillonnage au milieu du bit
            
            if filtered_signal(sample_index) > decision_threshold then
                received_bits(i) = 1;
            end
        end
        
        // BER calculation (Calcul du BER)
        errors = sum(transmitted_bits ~= received_bits);
        bit_error_rate = errors / parameters.number_of_bits; // BER
        
        disp('Affichage des graphiques...');
        
        // Display (Affichage)
        show_radio_results(transmitted_bits, received_bits, modulated_signal, filtered_signal, modulation_time, parameters, bit_error_rate);
        
        // Interpretation (Interpretation)
        if bit_error_rate == 0 then
            interpretation_text = sprintf('Transmission parfaite ! Les %d bits ont ete recus sans erreur (BER = 0%%). SNR: %.1f dB.', ...
                            parameters.number_of_bits, parameters.snr_db);
        else
            interpretation_text = sprintf('%d erreur(s) sur %d bits (BER = %.1f%%). Augmentez le SNR (%.1f dB) pour ameliorer la fiabilite.', ...
                            errors, parameters.number_of_bits, bit_error_rate*100, parameters.snr_db);
        end
        
        update_interpretation_zone(interpretation_text);
        
        disp('Traitement liaison radio termine !');
        
    catch
        disp('ERREUR dans process_radio_module');
        err = lasterror();
        disp('Message : ' + err.message);
        update_interpretation_zone('Erreur lors du traitement radio. Voir console.');
    end
endfunction
